ABLESTACK Mold는 부하분산 및 autoscale을 지원합니다. 본 문서에서는 사용자가 임시 서비스를 구성하고 부하분산 및 autoscale을 설정하는 방법을 설명합니다.

!!! info "가이드를 활용할 수 있는 운영체제"
CentOS는 RHEL의 Upstream 운영체제입니다. 일반적으로 Upstream 운영체제는 안정화된 Downstream 운영체제에 비해 최신화된 드라이버 및 애플리케이션이 포함될 수 있지만, 본 문서에서 설명하는 내용은 일반적인 가상머신 활용 방법을 설명하기 때문에 다음의 Downstream 운영체제에서도 동일하게 활용할 수 있습니다.

    - Redhat Enterprise Linux
    - Rockey Linux
    - AlmaLinux

## 부하분산 사용 준비

ABLESTACK은 대규모의 부하를 여러 가상머신으로 분산하여 트래픽 또는 컴퓨팅 자원을 분배하고, autoscale을 통해 부하의 양에 따라 효율적으로 자원을 사용할 수 있습니다.

- 네트워크 준비 : 가상머신을 실행하기 위한 임시 Isolated 네트워크를 준비합니다.
- 서비스 템플릿 준비 : 부팅후 자동으로 서비스가 시작될 수 있는 서비스 템플릿을 준비합니다. 템플릿 제작은 [ISO를 이용한 VM/템플릿 생성](../../vms/centos-guide-prepare-vm)을 참고해주세요

다음의 절차를 따라 부하분산 사용 준비를 수행합니다.


## 네트워크 준비

## 서비스 템플릿 준비

부하분산 서비스를 생성하기 전에, 먼저 서비스를 제공할 네트워크를 준비해야 합니다. ABLESTACK Mold의 부하분산 서비스를 사용하기 위한 네트워크 형식은 Isolated Network입니다.

가상머신에 연결할 네트워크를 준비하기 위해 `네트워크 > 가상머신용 네트워크` 화면으로 이동한 후 `네트워크 추가` 버튼을 클릭하여 "네트워크 추가" 대화상자를 표시합니다.

![centos-03-vm-prepare-network](../../assets/images/centos-03-vm-prepare-network.png){ width="400" }


"네트워크 추가" 대화 상자에서 "Isolated" 탭을 선택하면 다음과 같은 입력항목을 확인할 수 있습니다.

- 이름 : 신규로 생성할 네트워크의 이름
- 설명 : 네트워크에 대한 설명
- Zone : 네트워크가 배포될 ABLESTACK의 Zone
- 도메인 아이디 : 네트워크를 사용할 도메인 아이디 (기본값 : 네트워크를 생성한 도메인)
- 네트워크 오퍼링 : 네트워크에 적용할 네트워크 제공 정책 (특별한 설정이 없다면 기본 정책이 적용됨)
- 외부 아이디 : 외부 시스템(Mold와 연결된 SDN, 외부 네트워크 장치) 내의 네트워크 ID
- 게이트웨이 : Isolated 네트워크의 vRouter의 사설 네트워크의 IP 주소(자동으로 생성)
- 넷마스크 : Isolated 네트워크의 사설 네트워크의 서브넷 마스크(자동으로 생성)
- 네트워크 도메인 : 네트워크의 도메인 주소(자동으로 생성, cloud.internal)

가상머신 준비를 위한 네트워크는 위의 항목 중, 이름과 설명만 입력하면 기본값이 설정되어 자동으로 생성됩니다. 다음의 그림은 네트워크 생성 결과는 `네트워크 > 가상머신용 네트워크`에서 조회한 결과의 예 입니다.


![centos-04-vm-prepare-network](../../assets/images/centos-04-vm-prepare-network.png){ width="600" }

## 서비스 템플릿 준비

부하분산 서비스용 네트워크가 준비되었다면 이제 가상머신을 생성합니다. 가상머신 생성은 각 운영체제별 생성 가이드를 참고 바랍니다.

!!! info "가이드를 활용할 수 있는 운영체제"
CentOS는 RHEL의 Upstream 운영체제입니다. 일반적으로 Upstream 운영체제는 안정화된 Downstream 운영체제에 비해 최신화된 드라이버 및 애플리케이션이 포함될 수 있지만, 본 문서에서 설명하는 내용은 일반적인 가상머신 활용 방법을 설명하기 때문에 다음의 Downstream 운영체제에서도 동일하게 활용할 수 있습니다. 본 가이드에서는 예시로 Rocky Linux 9에 web서비스를 사용하여 부하분산을 진행합니다.
- [CentOS 가상머신 가이드](../../vms/centos-guide-prepare-vm/)
- [Ubuntu 가상머신 가이드](../../vms/ubuntu-guide-prepare-vm/)
- [Windows 가상머신 가이드](../../vms/windows-guide-prepare-vm/)


## 서비스 설치

가상머신이 실행되면 `컴퓨트 > 가상머신` 화면에 표시되는 목록에서 해당 가상머신의 실행 여부를 확인할 수 있습니다. 다음의 그림과 같습니다.

<center>
![centos-12-vm-start-with-iso](../../assets/images/centos-12-vm-start-with-iso.png){ width="600" }
</center>

위의 그림에서 :fontawesome-solid-ellipsis-v: 버튼에 마우스를 올려 놓으면 메뉴가 표시되는데 첫번째 메뉴 아이콘이 가상머신의 콘솔을 표시하는 메뉴입니다. 해당 메뉴를 클릭하면 브라우저의 신규 탭에 해당 가상머신의 콘솔이 다음과 같이 표시됩니다.

<center>
![centos-13-vm-console-connect](../../assets/images/centos-13-vm-console-connect.png){ width="600" }
</center>

콘솔에 접속했다면 `dnf` 명령을 사용해 httpd와 php를 설치한다.

```shell
dnf install -y httpd php
```

방화벽에 http 서비스를 추가한다.

```shell
firewall-cmd --add-service http --permanent
firewall-cmd --reload
```

sample php 파일을 생성한다.
```shell
echo '<?php echo gethostname(); phpinfo(); ?>' > /var/www/html/index.php
```

apache 서비스를 자동실행으로 등록한다.

```shell
systemctl enable --now httpd
```

## 가상머신 템플릿 생성

서비스 설치가 정상적으로 완료 되었다면, 마지막으로 가상머신 템플릿을 생성합니다. 가상머신 템플릿은 사용자가 생성한 가상머신의 형상을 그대로 이미지로 만들어, 언제든지 동일한 형상의 가상머신을 바로 만들 수 있도록 하기 위해 제공되는 기능입니다. 이 기능을 이용하여 Web, WAS등의 서비스를 확장할 수 있습니다. 

가상머신 템플릿을 생성하기 위해 실행 중인 가상머신을 정지합니다. 가상머신 목록 또는 상세화면의 가상머신 메뉴에서 "가상머신 정지" 버튼을 클릭합니다. 가상머신이 정지된 후 가상머신의 상세 페이지를 확인하면 다음과 같습니다.

![centos-15-vm-stopped-status](../../assets/images/centos-15-vm-stopped-status.png){ width="600" }

위의 화면에서 우측의 상세 화면에서 "볼륨" 탭을 클릭하면 해당 가상머신에 연결된 볼륨의 목록이 표시됩니다. 처음 만든 가상머신이기 때문에 ROOT 디스크만 표시됩니다. 해당 디스크를 클릭하여 볼륨의 상세 화면으로 이동합니다. 다음의 그림과 같습니다.

![centos-16-vm-root-volume-detail](../../assets/images/centos-16-vm-root-volume-detail.png){ width="600" }

위 화면에서 우측 상단의 볼륨 액션 메뉴 중 맨 우측의 "볼륨으로 템플릿 생성" 버튼을 클릭하여 가상머신 템플릿 생성을 시작합니다. 다음과 같은 "볼륨으로 템플릿 생성" 대화상자가 표시됩니다.

<center>
![centos-17-vm-volume-tmpl-dlg](../../assets/images/centos-17-vm-volume-tmpl-dlg.png){ width="400" }
</center>

"볼륨으로 템플릿 생성" 대화상자는 정지되어 있는 가상머신의 루트 디스크를 이용해 해당 가상머신에 대한 이미지를 생성하는 기능을 제공합니다. 다음의 정보를 입력합니다.

- 이름 : 템플릿 이미지의 이름 (예제에서는 "CentOS 9 기본 템플릿 이미지" )
- 설명 : 템플릿 이미지에 대한 설명 (예제에서는 이름과 동일하게 설정)
- OS유형 : 이미지의 원본 가상머신의 OS 유형 (예제에서는 CentOS 9)
- 공개 : 이미지를 모든 사용자에게 공개할 것인지의 여부 (예제에서는 공개)
- 추천 : 이미지를 추전 이미지로 설정할 것인지의 여부 (예제에서는 추천하지 않음)
- 동적으로 확장 가능 : 템플릿에 의해 생성된 가상머신에 대해 동적 스케일링을 지원할 것인지의 여부 (예제에서는 선택하지 않음)
- HVM : 하드웨어 가상화를 지원하는지의 여부 (예제에서는 선택)
- 비밀번호 관리 사용 : 가상머신 생성 시 root 사용자에 대한 비밀번호를 생성할 것인지의 여부 (예제에서는 선택하지 않음)

모든 정보를 입력한 후 "확인" 버튼을 눌러 템플릿 생성을 시작합니다. 생성이 완료되면 해당 템플릿은 `이미지 > 템플릿` 화면의 목록을 통해 확인할 수 있으며, 해당 목록을 클릭하여 상세화면으로 확인하면 다음과 같이 템플릿 이미지가 생성됨을 확인할 수 있습니다.

<center>
![centos-18-vm-template-detail](../../assets/images/centos-18-vm-template-detail.png){ width="600" }
</center>

이제 생성된 기본 템플릿을 이용해 언제든지 가상머신을 생성할 수 있습니다.

!!! info "템플릿을 생성한 원본 가상머신의 관리"
가상머신의 형상, 즉 최초로 생성한 원본 가상머신은 나중에 시스템을 운영할 때, 다양한 기능을 추가하여 템플릿을 생성하고자 할 때 유용하게 사용할 수 있습니다. 따라서 이러한 템플릿 운영 편리성을 위해 최초로 생성한 가상머신은 가상머신 스냅샷 등을 통해 시점별로 보관하여 관리하는 것을 권장합니다. 